<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.zw.jk.dao.ContractDao">

    <!-- 查询合同-->
    <select id="find" resultType="Contract" parameterType="map">
        SELECT
        (SELECT COUNT(*) FROM contract_product_c WHERE contract_id = c.contract_id)AS productNum,

        (SELECT COUNT(*) FROM ext_cproduct_c WHERE contract_product_id IN ( SELECT CONTRACT_PRODUCT_ID FROM contract_product_c WHERE CONTRACT_ID = c.contract_id))AS extnum,
        (
        (SELECT SUM(AMOUNT) FROM contract_product_c WHERE contract_id = c.contract_id) +
        (SELECT SUM(AMOUNT) FROM ext_cproduct_c WHERE contract_product_id IN ( SELECT CONTRACT_PRODUCT_ID FROM contract_product_c WHERE CONTRACT_ID = c.contract_id))
        ) as totalAmount ,c.CONTRACT_ID,c.OFFEROR,c.CONTRACT_NO,c.SIGNING_DATE,c.INPUT_BY,c.CHECK_BY,c.INSPECTOR,c.IMPORT_NUM,c.CREQUEST,c.CUSTOM_NAME,c.DELIVERY_PERIOD,c.SHIP_TIME,c.TRADE_TERMS,c.REMARK,c.PRINT_STYLE,c.OLD_STATE,c.STATE,c.OUT_STATE
        FROM contract_c c WHERE 1=1 <if test="state!= null" >state=#{state}</if>
    </select>

    <select id="get" resultType="Contract" >
        SELECT * from contract_c where CONTRACT_ID=#{id}
    </select>

    <insert id="insert" parameterType="Contract" >
        INSERT INTO  contract_c (CONTRACT_ID, OFFEROR, CONTRACT_NO, SIGNING_DATE, INPUT_BY, CHECK_BY, INSPECTOR, TOTAL_AMOUNT,
                                 CREQUEST, CUSTOM_NAME, SHIP_TIME, IMPORT_NUM, DELIVERY_PERIOD, REMARK, PRINT_STYLE, OLD_STATE,
                                 STATE, OUT_STATE, TRADE_TERMS, CREATE_TIME)
                VALUE (#{contractId},#{offeror},#{contractNo},#{signingDate},#{inputBy},#{checkBy},#{inspector},#{totalAmount},
                                #{crequest},#{customName},#{shipTime},#{importNum},#{deliveryPeriod},#{remark},#{printStyle},
                                #{oldState},#{state},#{outState},#{tradeTerms},#{createTime})
    </insert>

    <update id="update" parameterType="Contract">
        UPDATE contract_c
        <set>
            <if test="offeror!=null" >OFFEROR=#{offeror},</if>
            <if test="contractNo!=null" >CONTRACT_NO=#{contractNo},</if>
            <if test="signingDate!=null" >SIGNING_DATE=#{signingDate},</if>
            <if test="inputBy!=null" >INPUT_BY=#{inputBy},</if>
            <if test="checkBy!=null" >CHECK_BY=#{checkBy},</if>
            <if test="inspector!=null" >INSPECTOR=#{inspector},</if>
            <if test="totalAmount!=null" >TOTAL_AMOUNT=#{totalAmount},</if>
            <if test="crequest!=null" >CREQUEST=#{crequest},</if>
            <if test="customName!=null" > CUSTOM_NAME=#{customName},</if>
            <if test="shipTime!=null" >SHIP_TIME =#{shipTime},</if>
            <if test="importNum!=null" > IMPORT_NUM=#{importNum},</if>
            <if test="deliveryPeriod!=null" > DELIVERY_PERIOD=#{deliveryPeriod},</if>
            <if test="remark!=null" >REMARK =#{remark},</if>
            <if test="printStyle!=null" >PRINT_STYLE=#{printStyle},</if>
            <if test="oldState!=null" > OLD_STATE=#{oldState},</if>
            <if test="state!=null" >STATE =#{state},</if>
            <if test="outState!=null" > OUT_STATE=#{outState},</if>
            <if test="tradeTerms!=null" > TRADE_TERMS=#{tradeTerms},</if>
            <if test="createTime!=null" > CREATE_TIME=#{createTime}</if>
        </set>
        WHERE CONTRACT_ID=#{contractId}
    </update>
    
    <delete id="deleteById" >
        DELETE  FROM contract_c where CONTRACT_ID=#{id}
    </delete>
    
    <delete id="delete" >
        DELETE FROM  contract_c WHERE  CONTRACT_ID IN 
        <foreach collection="array" item="id" separator="," open="(" close=")" >
            #{id}
        </foreach>
    </delete>

    <update id="updateState" parameterType="map" >
        UPDATE  contract_c
          <set>
              <if test="oldState!=null" > OLD_STATE=#{oldState},</if>
              <if test="state!=null" >STATE =#{state},</if>
              <if test="outState!=null" > OUT_STATE=#{outState},</if>
          </set>
        where CONTRACT_ID = #{contractId}
    </update>

</mapper>